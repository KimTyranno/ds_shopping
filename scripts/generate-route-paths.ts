import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

// ES Module í™˜ê²½ì—ì„œ __dirname ë§Œë“¤ê¸°
const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const GROUPS = ['(auth)', '(public)', '(protected)'] as const
type Group = (typeof GROUPS)[number]

// locale ê²½ë¡œ í•˜ìœ„ í´ë”ìœ„ì¹˜
const APP_DIR = path.resolve(__dirname, '../src/app/[locale]')

// ìë™ ìƒì„±í•  ê²½ë¡œ ë° íŒŒì¼
const OUTPUT_DIR = path.resolve(__dirname, '../src/constants')
const isTemp = process.argv.includes('--temp')
const filename = isTemp ? 'paths.temp.ts' : 'paths.ts'
const OUTPUT_FILE = path.resolve(OUTPUT_DIR, filename)

// í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true })
}

/** í˜„ì¬ í´ë” í˜¹ì€ í•˜ìœ„í´ë”ì— page.* íŒŒì¼ì´ ìˆëŠ”ì§€ ê²€ì‚¬ */
function hasPageFile(folderPath: string): boolean {
  if (!fs.existsSync(folderPath)) return false

  const entries = fs.readdirSync(folderPath, { withFileTypes: true })

  // í´ë” ë‚´ì— ì§ì ‘ page.* íŒŒì¼ ìˆëŠ”ì§€ í™•ì¸
  if (entries.some(entry => entry.isFile() && entry.name.startsWith('page.'))) {
    return true
  }

  // í•˜ìœ„ í´ë” ì¤‘ì— page.*ê°€ ìˆìœ¼ë©´ true
  for (const entry of entries) {
    if (entry.isDirectory()) {
      // ì¬ê·€ì ìœ¼ë¡œ ê²€ì‚¬
      if (hasPageFile(path.join(folderPath, entry.name))) {
        return true
      }
    }
  }

  return false
}

/** ê·¸ë£¹ë³„(auth, public, protected) route ê²½ë¡œ ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜ */
function getRoutesFromGroup(group: Group): string[] {
  const groupPath = path.join(APP_DIR, group)
  if (!fs.existsSync(groupPath)) return []

  // ê·¸ë£¹ í´ë” ë‚´ ì²« ë‹¨ê³„ í´ë” í˜¹ì€ íŒŒì¼ ëª©ë¡
  const entries = fs.readdirSync(groupPath, { withFileTypes: true })
  const routes: string[] = []

  for (const entry of entries) {
    const entryPath = path.join(groupPath, entry.name)

    if (entry.isDirectory()) {
      // í˜„ì¬ í´ë” ì•ˆì— page.* íŒŒì¼ì´ ìˆê±°ë‚˜ í•˜ìœ„ í´ë”ì— ìˆìœ¼ë©´ ê²½ë¡œ ì¶”ê°€
      if (hasPageFile(entryPath)) {
        routes.push(`/${entry.name}`)
      }
    } else if (entry.name.startsWith('page.')) {
      // ê·¸ë£¹ ë£¨íŠ¸ì— page.* íŒŒì¼ì´ ìˆìœ¼ë©´ ë£¨íŠ¸ ê²½ë¡œ '/'
      routes.push('/')
    }
  }

  return routes
}

/** ì „ì²´ ê·¸ë£¹ì„ ìˆœíšŒí•´ì„œ ê²½ë¡œ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ */
function generatePaths() {
  const pathsByGroup: Record<string, string[]> = {}

  for (const group of GROUPS) {
    // (auth) => AUTH_PATHS ì´ëŸ° í˜•ì‹ìœ¼ë¡œ ìƒìˆ˜ëª… ìƒì„±
    const groupName = group.replace(/[()]/g, '').toUpperCase()
    pathsByGroup[`${groupName}_PATHS`] = getRoutesFromGroup(group)
  }

  // íŒŒì¼ í—¤ë” (ìë™ ìƒì„± ê²½ê³ )
  // const header = `// ğŸ”’ Auto-generated by generate-route-paths.ts â€” DO NOT EDIT MANUALLY\n\n`
  const header = `// ğŸ”’ ìë™ ìƒì„±ë˜ëŠ” íŒŒì¼ì´ë¯€ë¡œ ìˆ˜ì •ìœ¼ë¡œ í¸ì§‘í•˜ì§€ ë§ê²ƒ \n\n`

  // ê²½ë¡œë³„ë¡œ export ì½”ë“œ ìƒì„±
  const content = Object.entries(pathsByGroup)
    .map(([constName, paths]) => {
      return `export const ${constName} = ${JSON.stringify(paths, null, 2)};`
    })
    .join('\n\n')

  // ìµœì¢… íŒŒì¼ ì“°ê¸°
  fs.writeFileSync(OUTPUT_FILE, header + content + '\n')
  console.log(`âœ… ${filename} generated at src/constants/${filename}`)
}

generatePaths()
